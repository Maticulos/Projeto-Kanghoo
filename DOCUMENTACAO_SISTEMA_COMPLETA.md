# üìö DOCUMENTA√á√ÉO COMPLETA DO SISTEMA

## üéØ Vis√£o Geral do Sistema

Sistema completo de transporte escolar com rastreamento em tempo real, desenvolvido com Node.js, Koa.js e PostgreSQL. O sistema oferece funcionalidades para motoristas escolares, respons√°veis e administradores, com foco em seguran√ßa e monitoramento de crian√ßas.

### üèóÔ∏è Arquitetura do Sistema

```
üìÅ Sistema de Transporte Escolar
‚îú‚îÄ‚îÄ üñ•Ô∏è Backend (Node.js + Koa.js)
‚îÇ   ‚îú‚îÄ‚îÄ üîå APIs RESTful
‚îÇ   ‚îú‚îÄ‚îÄ üåê WebSocket (Tempo Real)
‚îÇ   ‚îú‚îÄ‚îÄ üóÑÔ∏è PostgreSQL Database
‚îÇ   ‚îú‚îÄ‚îÄ üîê Sistema de Autentica√ß√£o JWT
‚îÇ   ‚îú‚îÄ‚îÄ üìù Sistema de Logging Configur√°vel
‚îÇ   ‚îú‚îÄ‚îÄ üîß Constantes Centralizadas
‚îÇ   ‚îî‚îÄ‚îÄ üõ°Ô∏è Middleware de Seguran√ßa
‚îú‚îÄ‚îÄ üåê Frontend (HTML5 + JavaScript)
‚îÇ   ‚îú‚îÄ‚îÄ üì± Interface Responsiva
‚îÇ   ‚îú‚îÄ‚îÄ üó∫Ô∏è Integra√ß√£o Google Maps
‚îÇ   ‚îú‚îÄ‚îÄ üîî Notifica√ß√µes em Tempo Real
‚îÇ   ‚îú‚îÄ‚îÄ üì¶ Assets Organizados e Otimizados
‚îÇ   ‚îú‚îÄ‚îÄ üé® CSS Modular com Vari√°veis
‚îÇ   ‚îî‚îÄ‚îÄ ‚ö° Bundle Minificado para Performance
‚îî‚îÄ‚îÄ üîß Ferramentas de Desenvolvimento
    ‚îú‚îÄ‚îÄ üß™ Suite de Testes
    ‚îú‚îÄ‚îÄ üîç Ferramentas de Debug
    ‚îú‚îÄ‚îÄ üìä Monitoramento
    ‚îî‚îÄ‚îÄ üöÄ Build e Otimiza√ß√£o Automatizada
```

---

## üöÄ GUIA DE INSTALA√á√ÉO E CONFIGURA√á√ÉO

### üìã Pr√©-requisitos

- **Node.js** >= 16.0.0
- **PostgreSQL** >= 12.0
- **npm** ou **yarn**
- **Git**

### üîß Instala√ß√£o

1. **Clone o reposit√≥rio:**
```bash
git clone <repository-url>
cd teste
```

2. **Instale as depend√™ncias:**
```bash
cd server
npm install
```

3. **Configure as vari√°veis de ambiente:**
```bash
cp .env.example .env
```

Edite o arquivo `.env` com suas configura√ß√µes:
```env
# Banco de Dados
DB_HOST=localhost
DB_PORT=5432
DB_NAME=transporte_escolar
DB_USER=seu_usuario
DB_PASSWORD=sua_senha

# Servidor
PORT=5000
NODE_ENV=development

# Seguran√ßa
JWT_SECRET=seu_jwt_secret_muito_seguro
BCRYPT_ROUNDS=12

# APIs Externas
GOOGLE_MAPS_API_KEY=sua_chave_google_maps
```

4. **Configure o banco de dados:**
```bash
# Criar tabelas
node scripts/criar-tabelas-completas.js

# Criar dados de teste (opcional)
node debug-tools.js create-test
```

5. **Inicie o servidor:**
```bash
npm start
# ou para desenvolvimento
npm run dev
```

### üß™ Executar Testes

```bash
# Suite completa de testes
node test-suite.js

# Testes espec√≠ficos
npm test
```

---

## üóÑÔ∏è ESTRUTURA DO BANCO DE DADOS

### üìä Tabelas Principais

#### üë• usuarios
Armazena informa√ß√µes dos usu√°rios do sistema.

```sql
CREATE TABLE usuarios (
    id SERIAL PRIMARY KEY,
    nome_completo VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    tipo_cadastro VARCHAR(50) NOT NULL,
    telefone VARCHAR(20),
    endereco TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### üõ£Ô∏è rotas
Define as rotas dos motoristas.

```sql
CREATE TABLE rotas (
    id SERIAL PRIMARY KEY,
    motorista_id INTEGER REFERENCES usuarios(id),
    nome_rota VARCHAR(255) NOT NULL,
    origem VARCHAR(255),
    destino VARCHAR(255),
    horario_ida TIME,
    horario_volta TIME,
    ativa BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### üë∂ criancas
Informa√ß√µes das crian√ßas cadastradas.

```sql
CREATE TABLE criancas (
    id SERIAL PRIMARY KEY,
    nome_completo VARCHAR(255) NOT NULL,
    email_responsavel VARCHAR(255) NOT NULL,
    idade VARCHAR(10),
    escola VARCHAR(255),
    endereco_embarque TEXT,
    endereco_desembarque TEXT,
    observacoes TEXT,
    ativa BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### üöå viagens
Registra as viagens realizadas.

```sql
CREATE TABLE viagens (
    id SERIAL PRIMARY KEY,
    motorista_id INTEGER REFERENCES usuarios(id),
    rota_id INTEGER REFERENCES rotas(id),
    data_viagem DATE NOT NULL DEFAULT CURRENT_DATE,
    horario_inicio TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    horario_fim TIMESTAMP WITH TIME ZONE,
    tipo_viagem VARCHAR(50) DEFAULT 'ida',
    status VARCHAR(50) DEFAULT 'iniciada',
    distancia_total DECIMAL(8, 2),
    tempo_total INTEGER,
    observacoes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### üìç localizacoes
Armazena pontos de rastreamento GPS.

```sql
CREATE TABLE localizacoes (
    id SERIAL PRIMARY KEY,
    viagem_id INTEGER REFERENCES viagens(id),
    motorista_id INTEGER REFERENCES usuarios(id),
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    altitude DECIMAL(8, 2),
    velocidade DECIMAL(5, 2),
    direcao INTEGER,
    precisao DECIMAL(5, 2),
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    endereco TEXT,
    tipo_ponto VARCHAR(50) DEFAULT 'tracking',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

---

## üîå DOCUMENTA√á√ÉO DAS APIs

### üîê Autentica√ß√£o

Todas as rotas protegidas requerem token JWT:
```
Authorization: Bearer SEU_TOKEN_JWT
```

### üì± APIs do Motorista Escolar

**Base URL:** `/api/motorista-escolar`

#### Listar Crian√ßas
```http
GET /criancas
Authorization: Bearer {token}
```

**Resposta:**
```json
{
  "sucesso": true,
  "dados": [
    {
      "id": 1,
      "nome_completo": "Ana Silva",
      "idade": "8 anos",
      "escola": "Escola Municipal",
      "endereco_embarque": "Rua A, 123"
    }
  ]
}
```

#### Iniciar Viagem
```http
POST /iniciar-viagem
Authorization: Bearer {token}
Content-Type: application/json

{
  "rota_id": 1,
  "tipo_viagem": "ida"
}
```

#### Atualizar Localiza√ß√£o
```http
POST /atualizar-localizacao
Authorization: Bearer {token}
Content-Type: application/json

{
  "latitude": -23.5505,
  "longitude": -46.6333,
  "velocidade": 30,
  "direcao": 90
}
```

### üë®‚Äçüë©‚Äçüëß‚Äçüë¶ APIs do Respons√°vel

**Base URL:** `/api/responsavel`

#### Rastrear Crian√ßa
```http
GET /rastrear-crianca/:id
Authorization: Bearer {token}
```

#### Hist√≥rico de Viagens
```http
GET /historico-viagens/:crianca_id
Authorization: Bearer {token}
```

### üó∫Ô∏è APIs de Rastreamento

**Base URL:** `/api/tracking`

#### Localiza√ß√£o Atual
```http
GET /localizacao-atual/:motorista_id
```

#### Hist√≥rico de Localiza√ß√µes
```http
GET /historico/:motorista_id?data_inicio=2024-01-01&data_fim=2024-01-31
```

---

## üåê SISTEMA DE TEMPO REAL (WebSocket)

### üîå Conex√£o WebSocket

```javascript
const ws = new WebSocket('ws://localhost:5000');

ws.onopen = function() {
    console.log('Conectado ao WebSocket');
    
    // Autenticar
    ws.send(JSON.stringify({
        type: 'auth',
        token: 'seu_jwt_token'
    }));
};

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log('Mensagem recebida:', data);
};
```

### üì° Tipos de Eventos

#### Atualiza√ß√£o de Localiza√ß√£o
```json
{
  "type": "location_update",
  "data": {
    "motorista_id": 1,
    "latitude": -23.5505,
    "longitude": -46.6333,
    "velocidade": 30,
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

#### Embarque/Desembarque
```json
{
  "type": "boarding_event",
  "data": {
    "crianca_id": 1,
    "tipo": "embarque",
    "localizacao": {
      "latitude": -23.5505,
      "longitude": -46.6333
    },
    "timestamp": "2024-01-15T07:30:00Z"
  }
}
```

#### Notifica√ß√µes
```json
{
  "type": "notification",
  "data": {
    "titulo": "Crian√ßa Embarcou",
    "mensagem": "Ana Silva embarcou no transporte",
    "tipo": "info",
    "timestamp": "2024-01-15T07:30:00Z"
  }
}
```

---

## üîß FERRAMENTAS DE DESENVOLVIMENTO

### üß™ Suite de Testes (`test-suite.js`)

Script centralizado que executa todos os testes do sistema:

```bash
# Executar todos os testes
node test-suite.js

# Testes espec√≠ficos dispon√≠veis:
# - Conex√£o com banco de dados
# - Verifica√ß√£o de tabelas
# - Sistema de autentica√ß√£o
# - Sistema de rastreamento
# - Testes de performance
# - Testes de seguran√ßa
```

**Exemplo de uso:**
```bash
cd server
node test-suite.js
```

**Sa√≠da esperada:**
```
üß™ [2024-01-15T10:30:00.000Z] Executando: Conex√£o com Banco de Dados
‚úÖ [2024-01-15T10:30:01.000Z] Conex√£o com Banco de Dados - PASSOU
üß™ [2024-01-15T10:30:01.000Z] Executando: Verifica√ß√£o de Tabelas
‚úÖ [2024-01-15T10:30:02.000Z] Verifica√ß√£o de Tabelas - PASSOU

üìä RELAT√ìRIO FINAL DE TESTES
Total de Testes: 8
‚úÖ Passou: 8
‚ùå Falhou: 0
üìà Taxa de Sucesso: 100.0%
```

### üîç Ferramentas de Debug (`debug-tools.js`)

Script centralizado para debug e diagn√≥stico:

```bash
# Modo interativo
node debug-tools.js

# Comandos espec√≠ficos
node debug-tools.js check              # Verificar conex√£o
node debug-tools.js tables             # Listar tabelas
node debug-tools.js analyze usuarios   # Analisar tabela espec√≠fica
node debug-tools.js users              # Analisar usu√°rios
node debug-tools.js tracking           # Analisar rastreamento
node debug-tools.js create-test        # Criar dados de teste
node debug-tools.js clean-test         # Limpar dados de teste
node debug-tools.js optimize           # Otimizar banco
```

**Menu Interativo:**
```
üîß FERRAMENTAS DE DEBUG - MENU PRINCIPAL
==================================================
1. üì° Verificar conex√£o com banco
2. üìã Listar todas as tabelas
3. üîç Analisar tabela espec√≠fica
4. üë• Analisar usu√°rios
5. üó∫Ô∏è Analisar rastreamento
6. üß™ Criar dados de teste
7. üóëÔ∏è Limpar dados de teste
8. ‚ö° Otimizar banco de dados
9. üö™ Sair
==================================================
```

---

## üîí SEGURAN√áA

### üõ°Ô∏è Medidas Implementadas

1. **Autentica√ß√£o JWT**
   - Tokens com expira√ß√£o
   - Refresh tokens
   - Valida√ß√£o em todas as rotas protegidas

2. **Hash de Senhas**
   - bcrypt com 12 rounds
   - Salt autom√°tico

3. **Valida√ß√£o de Dados**
   - Sanitiza√ß√£o de inputs
   - Valida√ß√£o de tipos
   - Prote√ß√£o contra SQL injection

4. **Rate Limiting**
   - Limite de requisi√ß√µes por IP
   - Prote√ß√£o contra ataques DDoS

5. **CORS Configurado**
   - Origens permitidas espec√≠ficas
   - Headers controlados

### üîê Configura√ß√µes de Seguran√ßa

```javascript
// Exemplo de configura√ß√£o JWT
const jwtConfig = {
    secret: process.env.JWT_SECRET,
    expiresIn: '24h',
    algorithm: 'HS256'
};

// Configura√ß√£o bcrypt
const bcryptRounds = 12;
```

---

## üìä MONITORAMENTO E LOGS

### üìà M√©tricas do Sistema

O sistema coleta automaticamente:
- N√∫mero de conex√µes WebSocket ativas
- Lat√™ncia do banco de dados
- N√∫mero de localiza√ß√µes processadas
- Tempo de resposta das APIs
- Erros e exce√ß√µes

### üìù Sistema de Logs

```javascript
// Exemplo de log estruturado
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "info",
  "message": "Localiza√ß√£o atualizada",
  "data": {
    "motorista_id": 1,
    "latitude": -23.5505,
    "longitude": -46.6333
  }
}
```

---

## üö® SOLU√á√ÉO DE PROBLEMAS

### ‚ùå Problemas Comuns

#### 1. Erro de Conex√£o com Banco
```bash
# Verificar conex√£o
node debug-tools.js check

# Verificar vari√°veis de ambiente
cat .env
```

#### 2. WebSocket n√£o Conecta
```bash
# Verificar se o servidor est√° rodando
curl http://localhost:5000/health

# Verificar logs do servidor
tail -f logs/server.log
```

#### 3. Testes Falhando
```bash
# Executar diagn√≥stico completo
node test-suite.js

# Verificar estrutura do banco
node debug-tools.js tables
```

### üîß Comandos de Manuten√ß√£o

```bash
# Otimizar banco de dados
node debug-tools.js optimize

# Limpar dados antigos
node debug-tools.js clean-test

# Recriar tabelas (CUIDADO!)
node scripts/criar-tabelas-completas.js
```

---

## üìö REFER√äNCIAS E RECURSOS

### üìñ Documenta√ß√£o T√©cnica

- [Node.js Documentation](https://nodejs.org/docs/)
- [Koa.js Guide](https://koajs.com/)
- [PostgreSQL Manual](https://www.postgresql.org/docs/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

### üõ†Ô∏è Ferramentas Utilizadas

- **Backend**: Node.js, Koa.js, PostgreSQL
- **Frontend**: HTML5, CSS3, JavaScript ES6+
- **Tempo Real**: WebSocket, Socket.IO
- **Mapas**: Google Maps API
- **Autentica√ß√£o**: JWT, bcrypt
- **Testes**: Mocha, Chai
- **Monitoramento**: Custom logging system

### üìû Suporte

Para suporte t√©cnico ou d√∫vidas:
1. Consulte esta documenta√ß√£o
2. Execute as ferramentas de debug
3. Verifique os logs do sistema
4. Execute a suite de testes

---

## üöÄ MELHORIAS IMPLEMENTADAS

### üñ•Ô∏è Backend - Melhorias de Arquitetura

#### üìù Sistema de Logging Configur√°vel
- **Localiza√ß√£o**: `server/utils/logger.js`
- **Funcionalidades**:
  - M√∫ltiplos n√≠veis de log (debug, info, warn, error)
  - Formata√ß√£o consistente com timestamps
  - Configura√ß√£o via vari√°veis de ambiente
  - Filtragem por n√≠vel de severidade
  - Logs estruturados para an√°lise
  - Sanitiza√ß√£o autom√°tica de dados sens√≠veis

#### üîß Centraliza√ß√£o de Constantes
- **Localiza√ß√£o**: `server/config/constants.js`
- **Constantes Organizadas**:
  - `USER_TYPES`: Tipos de usu√°rio do sistema
  - `PAGINATION`: Configura√ß√µes de pagina√ß√£o
  - `TRANSPORT_TYPES`: Tipos de transporte
  - `TRIP_STATUS`: Status de viagens
  - `NOTIFICATION_TYPES`: Tipos de notifica√ß√£o
  - `HTTP_STATUS`: C√≥digos de status HTTP
  - `FILE_CONFIG`: Configura√ß√µes de arquivos
  - `CACHE_CONFIG`: Configura√ß√µes de cache
  - `RATE_LIMIT`: Limites de requisi√ß√µes
  - `WEBSOCKET_CONFIG`: Configura√ß√µes WebSocket
  - `SECURITY_CONFIG`: Configura√ß√µes de seguran√ßa
  - `MESSAGES`: Mensagens padronizadas
  - `REGEX`: Express√µes regulares reutiliz√°veis

#### üßπ Remo√ß√£o de Console.logs
- Substitui√ß√£o de `console.log` por sistema de logging estruturado
- Logs categorizados por contexto e severidade
- Melhor rastreabilidade e debugging

### üåê Frontend - Otimiza√ß√£o de Assets

#### üì¶ Reorganiza√ß√£o de Arquivos
- **Nova Estrutura**:
  ```
  frontend/public/assets/
  ‚îú‚îÄ‚îÄ css/
  ‚îÇ   ‚îú‚îÄ‚îÄ core/          # CSS fundamental
  ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Componentes reutiliz√°veis
  ‚îÇ   ‚îî‚îÄ‚îÄ vendors/       # Bibliotecas externas
  ‚îú‚îÄ‚îÄ js/
  ‚îÇ   ‚îú‚îÄ‚îÄ core/          # JavaScript fundamental
  ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Componentes reutiliz√°veis
  ‚îÇ   ‚îú‚îÄ‚îÄ animations/    # Anima√ß√µes
  ‚îÇ   ‚îú‚îÄ‚îÄ api/           # Integra√ß√µes de API
  ‚îÇ   ‚îî‚îÄ‚îÄ vendors/       # Bibliotecas externas
  ‚îî‚îÄ‚îÄ images/            # Recursos visuais
  ```

#### ‚ö° Otimiza√ß√£o de Performance
- **Bundle Minificado**: CSS e JS concatenados e minificados
- **Cache Busting**: Versionamento autom√°tico de assets
- **Preload**: Carregamento otimizado de recursos cr√≠ticos
- **Compress√£o**: Assets comprimidos para menor tamanho

#### üé® CSS Modular
- **Vari√°veis CSS**: Sistema de design tokens
- **Utilit√°rios**: Classes reutiliz√°veis para espa√ßamento, cores, tipografia
- **Componentes**: Estilos modulares e reutiliz√°veis
- **Responsividade**: Design adaptativo para todos os dispositivos

#### üîß Build Automatizado
- **Script de Build**: `frontend/build-optimization.js`
- **Funcionalidades**:
  - Organiza√ß√£o autom√°tica de arquivos
  - Concatena√ß√£o e minifica√ß√£o
  - Atualiza√ß√£o de refer√™ncias HTML
  - Gera√ß√£o de manifesto de assets
  - Versionamento para cache

### üìä Ferramentas de Debug Aprimoradas

#### üß™ Sistema de Testes
- Suite completa de testes automatizados
- Testes de integra√ß√£o para APIs
- Valida√ß√£o de dados e seguran√ßa
- Cobertura de c√≥digo

#### üîç Monitoramento
- Logs estruturados para an√°lise
- M√©tricas de performance
- Rastreamento de erros
- Alertas autom√°ticos

---

## üîÑ CHANGELOG

### Vers√£o 1.1.0 (Atual)
- ‚úÖ Sistema completo de rastreamento
- ‚úÖ APIs RESTful implementadas
- ‚úÖ WebSocket para tempo real
- ‚úÖ Interface web responsiva
- ‚úÖ Sistema de autentica√ß√£o
- ‚úÖ Ferramentas de debug e teste
- ‚úÖ Documenta√ß√£o completa
- üÜï **Sistema de logging configur√°vel**
- üÜï **Constantes centralizadas**
- üÜï **Assets organizados e otimizados**
- üÜï **CSS modular com vari√°veis**
- üÜï **Build automatizado**
- üÜï **Performance otimizada**

### Pr√≥ximas Vers√µes
- üîÑ Dashboard administrativo
- üîÑ Relat√≥rios avan√ßados
- üîÑ Notifica√ß√µes push
- üîÑ App mobile
- üîÑ Integra√ß√£o com APIs externas

---

*Documenta√ß√£o atualizada em: Janeiro 2024*
*Vers√£o do Sistema: 1.0.0*